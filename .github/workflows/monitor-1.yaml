name: SageMaker Model Monitor (Iris) - Production

on:
  workflow_dispatch:

jobs:
  model_monitor:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1

      # Your endpoint + role
      ENDPOINT_NAME: iris-endpoint
      SAGEMAKER_EXEC_ROLE_ARN: arn:aws:iam::387867038403:role/AqeelIrisSageMakerExecutionRole

      # Buckets / paths
      S3_BUCKET: sagemaker-aqeel-iris-us-east-1-387867038403
      DATACAPTURE_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/datacapture/

      # Baseline dataset (features only, header=True)
      # BASELINE_DATASET_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/datasets/iris/features.csv
      BASELINE_DATASET_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/datasets/iris/baseline/
      BASELINE_OUTPUT_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/baseline

      # Model Monitor reports
      REPORTS_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/reports

      # Monitoring schedule
      SCHEDULE_NAME: aqeel-iris-model-monitor
      CRON: cron(0 * ? * * *)  # hourly
      PROCESSING_INSTANCE_TYPE: ml.t3.large

      # Alerting (SNS topic name)
      SNS_TOPIC_NAME: aqeel-iris-drift-alerts

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r monitoring/requirements.txt

      # 1) Enable DataCapture on the endpoint (idempotent)
      - name: Enable Data Capture (EndpointConfig update)
        run: |
          python monitoring/enable_data_capture.py \
            --region "${{ env.AWS_REGION }}" \
            --endpoint-name "${{ env.ENDPOINT_NAME }}" \
            --capture-s3-uri "${{ env.DATACAPTURE_S3_URI }}" \
            --sampling-percentage 100

      # 2) Create / refresh baseline (statistics.json + constraints.json)
      - name: Create/Update Baseline (Model Monitor)
        run: |
          python monitoring/mm_create_baseline.py \
            --region "${{ env.AWS_REGION }}" \
            --role-arn "${{ env.SAGEMAKER_EXEC_ROLE_ARN }}" \
            --baseline-data-s3-uri "${{ env.BASELINE_DATASET_S3_URI }}" \
            --baseline-output-s3-uri "${{ env.BASELINE_OUTPUT_S3_URI }}" \
            --instance-type "${{ env.PROCESSING_INSTANCE_TYPE }}"

      # 3) Create / recreate monitoring schedule
      - name: Create/Update Monitoring Schedule (Model Monitor)
        run: |
          python monitoring/mm_create_schedule.py \
            --region "${{ env.AWS_REGION }}" \
            --role-arn "${{ env.SAGEMAKER_EXEC_ROLE_ARN }}" \
            --endpoint-name "${{ env.ENDPOINT_NAME }}" \
            --schedule-name "${{ env.SCHEDULE_NAME }}" \
            --baseline-s3-uri "${{ env.BASELINE_OUTPUT_S3_URI }}" \
            --monitor-output-s3-uri "${{ env.REPORTS_S3_URI }}" \
            --datacapture-s3-uri "${{ env.DATACAPTURE_S3_URI }}" \
            --cron "${{ env.CRON }}" \
            --instance-type "${{ env.PROCESSING_INSTANCE_TYPE }}"

      # 4) Create SNS + CloudWatch alarm for drift (constraint violations)
      # IMPORTANT: add GitHub secret ALERT_EMAIL (your email) and confirm subscription from inbox.
      - name: Create Drift Alarm (CloudWatch + SNS)
        run: |
          python monitoring/mm_create_drift_alarm.py \
            --region "${{ env.AWS_REGION }}" \
            --schedule-name "${{ env.SCHEDULE_NAME }}" \
            --sns-topic-name "${{ env.SNS_TOPIC_NAME }}" \
            --email "${{ secrets.ALERT_EMAIL }}"













# name: SageMaker Model Monitor (Iris)

# on:
#   workflow_dispatch:

# jobs:
#   model_monitor:
#     runs-on: ubuntu-latest

#     env:
#       AWS_REGION: us-east-1
#       ENDPOINT_NAME: iris-endpoint
#       SAGEMAKER_EXEC_ROLE_ARN: arn:aws:iam::387867038403:role/AqeelIrisSageMakerExecutionRole

#       S3_BUCKET: sagemaker-aqeel-iris-us-east-1-387867038403

#       BASELINE_DATASET_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/datasets/iris/features.csv
#       BASELINE_OUTPUT_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/baseline
#       REPORTS_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/reports
#       DATACAPTURE_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/datacapture

#       SCHEDULE_NAME: aqeel-iris-model-monitor
#       PROCESSING_INSTANCE_TYPE: ml.t3.large

#     steps:
#       - uses: actions/checkout@v4

#       - name: Configure AWS Credentials
#         uses: aws-actions/configure-aws-credentials@v4
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.11"

#       - name: Install deps
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r monitoring/requirements.txt

#       - name: Create/Update Baseline (Model Monitor)
#         run: |
#           python monitoring/mm_create_baseline.py \
#             --region "${{ env.AWS_REGION }}" \
#             --role-arn "${{ env.SAGEMAKER_EXEC_ROLE_ARN }}" \
#             --baseline-data-s3-uri "${{ env.BASELINE_DATASET_S3_URI }}" \
#             --baseline-output-s3-uri "${{ env.BASELINE_OUTPUT_S3_URI }}" \
#             --instance-type "${{ env.PROCESSING_INSTANCE_TYPE }}"

#       - name: Create/Update Monitoring Schedule (Model Monitor)
#         run: |
#           python monitoring/mm_create_schedule.py \
#             --region $AWS_REGION \
#             --role-arn $SAGEMAKER_EXEC_ROLE_ARN \
#             --endpoint-name $ENDPOINT_NAME \
#             --schedule-name aqeel-iris-model-monitor \
#             --baseline-s3-uri s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/baseline/ \
#             --monitor-output-s3-uri s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/reports/ \
#             --datacapture-s3-uri s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/datacapture/ \
#             --cron "cron(0 * ? * * *)" \
#             --instance-type ml.t3.medium