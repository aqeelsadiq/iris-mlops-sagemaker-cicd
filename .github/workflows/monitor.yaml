name: Setup Model Monitoring (Iris)

on:
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      ENDPOINT_NAME: iris-endpoint
      DEFAULT_BUCKET: sagemaker-aqeel-iris-us-east-1-387867038403

      # âœ… Use FEATURES baseline (4 columns + header, no label)
      BASELINE_DATASET_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/datasets/iris/features.csv

      DATACAPTURE_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/datacapture/
      BASELINE_OUTPUT_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/baseline/
      REPORTS_S3_URI: s3://sagemaker-aqeel-iris-us-east-1-387867038403/monitoring/reports/

      SCHEDULE_NAME: aqeel-iris-data-monitor
      ALERT_EMAIL: aqeel.sadiq3456@gmail.com
      SAGEMAKER_EXEC_ROLE_ARN: arn:aws:iam::387867038403:role/AqeelIrisSageMakerExecutionRole

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip uninstall -y sagemaker || true
          python -m pip install --no-cache-dir "sagemaker==2.231.0" "boto3>=1.34.0"
          python -c "import sagemaker; print('sagemaker version:', sagemaker.__version__)"
          python -c "from sagemaker.model_monitor import DefaultModelMonitor; print('ModelMonitor OK')"

      - name: Enable Data Capture
        run: |
          python monitoring/enable_data_capture.py \
            --region $AWS_REGION \
            --endpoint-name $ENDPOINT_NAME \
            --capture-s3-uri $DATACAPTURE_S3_URI \
            --sampling-percentage 100

      - name: Create Baseline
        run: |
          python monitoring/create_baseline.py \
            --region $AWS_REGION \
            --role-arn $SAGEMAKER_EXEC_ROLE_ARN \
            --baseline-data-s3-uri $BASELINE_DATASET_S3_URI \
            --baseline-output-s3-uri $BASELINE_OUTPUT_S3_URI \
            --instance-type ml.t3.medium \
            --job-name baseline-suggestion-1

      - name: Create Monitoring Schedule
        run: |
          python monitoring/create_monitor_schedule.py \
            --region $AWS_REGION \
            --role-arn $SAGEMAKER_EXEC_ROLE_ARN \
            --endpoint-name $ENDPOINT_NAME \
            --schedule-name $SCHEDULE_NAME \
            --baseline-s3-uri $BASELINE_OUTPUT_S3_URI \
            --monitor-output-s3-uri $REPORTS_S3_URI \
            --cron "cron(0 * ? * * *)" \
            --instance-type ml.t3.medium

      - name: Create SNS + Failure Notifications
        run: |
          python monitoring/create_alarm_sns.py \
            --region $AWS_REGION \
            --schedule-name $SCHEDULE_NAME \
            --email $ALERT_EMAIL
